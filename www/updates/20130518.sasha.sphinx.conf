#####################
#   mam.bizes 		#
#####################
source mam_bizes
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = rdflhjcjan
    sql_db          = mam
    sql_port        = 3306
    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO sphinx_counters SELECT 'biz', MAX(id), NOW() FROM bizes
    sql_range_step  = 1000
    sql_query_range = SELECT (SELECT MIN(id) FROM bizes), (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'biz')
    sql_query       = \
		SELECT \
			id, \
			bizes.id AS biz_id, \
			bizes.number, \
			bizes.suffix, \
			bizes.title AS biz_title, \
			CONCAT(IF(bizes.number > 999, '', IF(bizes.number > 99, '0', IF(bizes.number > 9, '00', '000'))), bizes.number, IF(bizes.suffix > 0, CONCAT('.', IF(bizes.suffix < 10, CONCAT('0', bizes.suffix), bizes.suffix)), '')) AS full_number, \
			bizes.description, \
			(SELECT title FROM objectives WHERE id = bizes.objective_id) AS objective, \
			(SELECT title FROM markets WHERE id = bizes.market_id) AS market, \
			(SELECT title FROM teams WHERE id = bizes.team_id) AS team, \
			(SELECT title FROM products WHERE id = bizes.product_id) AS product, \
			bizes.`status`, \
			(SELECT CONCAT(login, ',', nickname) FROM users WHERE id = bizes.driver_id) AS driver, \
			UNIX_TIMESTAMP(bizes.modified_at) AS modified_at, \
			(SELECT GROUP_CONCAT(sf_biz_search_company_role(company_id, role) SEPARATOR ",") FROM biz_companies WHERE biz_id = bizes.id) AS biz_company_role, \
			sf_biz_search_last_activity(id) AS last_access_at \
		FROM bizes \
		WHERE bizes.id >= $start AND bizes.id <= $end AND bizes.id <= (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'biz')
    sql_attr_uint 		= biz_id
	sql_attr_uint 		= number
	sql_attr_uint 		= suffix
	sql_attr_timestamp  = modified_at
	sql_attr_timestamp  = last_access_at
}

source mam_bizes_delta : mam_bizes {
    type 			= mysql
    sql_query_pre 	= SET NAMES utf8
    sql_range_step 	= 1000
    sql_query_range =
    sql_query       = \
		SELECT \
			id, \
			bizes.id AS biz_id, \
			bizes.number, \
			bizes.suffix, \
			bizes.title AS biz_title, \
			CONCAT(IF(bizes.number > 999, '', IF(bizes.number > 99, '0', IF(bizes.number > 9, '00', '000'))), bizes.number, IF(bizes.suffix > 0, CONCAT('.', IF(bizes.suffix < 10, CONCAT('0', bizes.suffix), bizes.suffix)), '')) AS full_number, \
			bizes.description, \
			(SELECT title FROM objectives WHERE id = bizes.objective_id) AS objective, \
			(SELECT title FROM markets WHERE id = bizes.market_id) AS market, \
			(SELECT title FROM teams WHERE id = bizes.team_id) AS team, \
			(SELECT title FROM products WHERE id = bizes.product_id) AS product, \
			bizes.`status`, \
			(SELECT CONCAT(login, ',', nickname) FROM users WHERE id = bizes.driver_id) AS driver, \
			UNIX_TIMESTAMP(bizes.modified_at) AS modified_at, \
			(SELECT GROUP_CONCAT(sf_biz_search_company_role(company_id, role) SEPARATOR ",") FROM biz_companies WHERE biz_id = bizes.id) AS biz_company_role, \
			sf_biz_search_last_activity(id) AS last_access_at \
		FROM bizes \
		WHERE bizes.id > (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'biz') \
		OR bizes.modified_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'biz')
    sql_query_killlist = SELECT id FROM bizes WHERE modified_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'biz')	
}

source mam_bizes_filter
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = rdflhjcjan
    sql_db          = mam
    sql_port        = 3306
    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO sphinx_counters SELECT 'biz', MAX(bizes.id), NOW() FROM bizes
    sql_range_step  = 1000
    sql_query_range = SELECT (SELECT MIN(bizes.id) FROM bizes), (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'biz')
    sql_query       = \
		SELECT \
			id AS id, \
			bizes.id AS biz_id, \
			bizes.objective_id, \
			bizes.number, \
			bizes.suffix, \
			bizes.team_id, \
			bizes.product_id, \
			bizes.market_id, \
			CRC32(bizes.status) AS status_id, \
			bizes.title AS biz_title, \
			CONCAT(IF(bizes.number > 999, '', IF(bizes.number > 99, '0', IF(bizes.number > 9, '00', '000'))), bizes.number, IF(bizes.suffix > 0, CONCAT('.', IF(bizes.suffix < 10, CONCAT('0', bizes.suffix), bizes.suffix)), '')) AS full_number, \
			CONCAT('biz', IF(bizes.number > 999, '', IF(bizes.number > 99, '0', IF(bizes.number > 9, '00', '000'))), bizes.number, IF(bizes.suffix > 0, CONCAT('.', IF(bizes.suffix < 10, CONCAT('0', bizes.suffix), bizes.suffix)), '')) AS biz_full_number, \
			bizes.description, \
			UNIX_TIMESTAMP(bizes.modified_at) AS modified_at, \
			sf_biz_search_last_activity(bizes.id) AS last_access_at \
		FROM bizes \
		WHERE bizes.id >= $start AND bizes.id <= $end AND bizes.id <= (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'biz')
    sql_attr_uint 		= biz_id
    sql_attr_uint 		= objective_id
    sql_attr_uint 		= team_id
    sql_attr_uint       = market_id
    sql_attr_uint 		= product_id
    sql_attr_uint 		= status_id
	sql_attr_uint 		= number
	sql_attr_uint 		= suffix
	sql_attr_timestamp  = modified_at
	sql_attr_timestamp  = last_access_at
}

source mam_bizes_filter_delta : mam_bizes_filter {
    type 			= mysql
    sql_query_pre 	= SET NAMES utf8
    sql_range_step 	= 1000
    sql_query_range =
    sql_query       = \
		SELECT \
			id AS id, \
			bizes.id AS biz_id, \
			bizes.objective_id, \
			bizes.number, \
			bizes.suffix, \
			bizes.team_id, \
			bizes.product_id, \
			bizes.market_id, \
			bizes.title AS biz_title, \
			CRC32(bizes.status) AS status_id,\
			bizes.driver_id, \
			CONCAT(IF(bizes.number > 999, '', IF(bizes.number > 99, '0', IF(bizes.number > 9, '00', '000'))), bizes.number, IF(bizes.suffix > 0, CONCAT('.', IF(bizes.suffix < 10, CONCAT('0', bizes.suffix), bizes.suffix)), '')) AS full_number, \
			CONCAT('biz', IF(bizes.number > 999, '', IF(bizes.number > 99, '0', IF(bizes.number > 9, '00', '000'))), bizes.number, IF(bizes.suffix > 0, CONCAT('.', IF(bizes.suffix < 10, CONCAT('0', bizes.suffix), bizes.suffix)), '')) AS biz_full_number, \
			bizes.description, \
			UNIX_TIMESTAMP(bizes.modified_at) AS modified_at, \
			sf_biz_search_last_activity(bizes.id) AS last_access_at \
		FROM bizes \
		WHERE bizes.id > (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'biz') \
		OR bizes.modified_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'biz')
    sql_query_killlist = SELECT id FROM bizes WHERE modified_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'biz')	
}

source mam_bizes_users
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = rdflhjcjan
    sql_db          = mam
    sql_port        = 3306
    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO sphinx_counters SELECT 'biz', MAX(bizes.id), NOW() FROM bizes
    sql_range_step  = 1000
    sql_query_range = SELECT (SELECT MIN(bizes.id) FROM bizes), (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'biz')
    sql_query       = \
		SELECT \
			biz_users.id AS id, \
			bizes.id AS biz_id, \
			bizes.objective_id, \
			bizes.number, \
			bizes.suffix, \
			bizes.team_id, \
			bizes.product_id, \
			bizes.market_id, \
			biz_users.user_id, \
			CRC32(bizes.status) AS status_id, \
			bizes.title AS biz_title, \
			CONCAT(IF(bizes.number > 999, '', IF(bizes.number > 99, '0', IF(bizes.number > 9, '00', '000'))), bizes.number, IF(bizes.suffix > 0, CONCAT('.', IF(bizes.suffix < 10, CONCAT('0', bizes.suffix), bizes.suffix)), '')) AS full_number, \
			CONCAT('biz', IF(bizes.number > 999, '', IF(bizes.number > 99, '0', IF(bizes.number > 9, '00', '000'))), bizes.number, IF(bizes.suffix > 0, CONCAT('.', IF(bizes.suffix < 10, CONCAT('0', bizes.suffix), bizes.suffix)), '')) AS biz_full_number, \
			bizes.description, \
			UNIX_TIMESTAMP(bizes.modified_at) AS modified_at, \
			sf_biz_search_last_activity(bizes.id) AS last_access_at \
		FROM biz_users \
		LEFT JOIN bizes ON biz_users.biz_id = bizes.id \
		WHERE bizes.id >= $start AND bizes.id <= $end AND bizes.id <= (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'biz')
    sql_attr_uint 		= biz_id
    sql_attr_uint 		= objective_id
    sql_attr_uint 		= team_id
    sql_attr_uint       = market_id
    sql_attr_uint 		= product_id
    sql_attr_uint 		= user_id
    sql_attr_uint 		= status_id
	sql_attr_uint 		= number
	sql_attr_uint 		= suffix
	sql_attr_timestamp  = modified_at
	sql_attr_timestamp  = last_access_at
}

source mam_bizes_users_delta : mam_bizes_users {
    type 			= mysql
    sql_query_pre 	= SET NAMES utf8
    sql_range_step 	= 1000
    sql_query_range =
    sql_query       = \
		SELECT \
			biz_users.id AS id, \
			bizes.id AS biz_id, \
			bizes.objective_id, \
			bizes.number, \
			bizes.suffix, \
			bizes.team_id, \
			bizes.product_id, \
			bizes.market_id, \
			bizes.title AS biz_title, \
			CRC32(bizes.status) AS status_id,\
			biz_users.user_id, \
			CONCAT(IF(bizes.number > 999, '', IF(bizes.number > 99, '0', IF(bizes.number > 9, '00', '000'))), bizes.number, IF(bizes.suffix > 0, CONCAT('.', IF(bizes.suffix < 10, CONCAT('0', bizes.suffix), bizes.suffix)), '')) AS full_number, \
			CONCAT('biz', IF(bizes.number > 999, '', IF(bizes.number > 99, '0', IF(bizes.number > 9, '00', '000'))), bizes.number, IF(bizes.suffix > 0, CONCAT('.', IF(bizes.suffix < 10, CONCAT('0', bizes.suffix), bizes.suffix)), '')) AS biz_full_number, \
			bizes.description, \
			UNIX_TIMESTAMP(bizes.modified_at) AS modified_at, \
			sf_biz_search_last_activity(bizes.id) AS last_access_at \
		FROM bizes \
		LEFT JOIN biz_users ON bizes.id = biz_users.biz_id \
		WHERE bizes.id > (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'biz') \
		OR bizes.modified_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'biz')
    sql_query_killlist = SELECT id FROM bizes WHERE modified_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'biz')	
}

index ix_mam_bizes
{
    source          = mam_bizes
    path            = /etc/sphinxsearch/data/mam_bizes
    enable_star 	= 1
	min_word_len    = 3	
	min_infix_len 	= 4
    charset_type    = utf-8
	ignore_chars 	= U+2E
}

index ix_mam_bizes_filter
{
    source          = mam_bizes_filter
    path            = /etc/sphinxsearch/data/mam_bizes_filter
    enable_star 	= 1
	min_word_len    = 3	
	min_infix_len 	= 4
    charset_type    = utf-8
	ignore_chars 	= U+2E
}

index ix_mam_bizes_users
{
    source          = mam_bizes_users
    path            = /etc/sphinxsearch/data/mam_bizes_users
    enable_star 	= 1
	min_word_len    = 3	
	min_infix_len 	= 4
    charset_type    = utf-8
	ignore_chars 	= U+2E
}

index ix_mam_bizes_delta : ix_mam_bizes
{
    source          = mam_bizes_delta
    path            = /etc/sphinxsearch/data/mam_bizes_delta
}

index ix_mam_bizes_filter_delta : ix_mam_bizes_filter
{
    source          = mam_bizes_filter_delta
    path            = /etc/sphinxsearch/data/mam_bizes_filter_delta
}

index ix_mam_bizes_users_delta : ix_mam_bizes_users
{
    source          = mam_bizes_users_delta
    path            = /etc/sphinxsearch/data/mam_bizes_users_delta
}
