#####################
#   mam.persons   	#
#####################
source mam_persons
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = 
    sql_db          = mam
    sql_port        = 3306  # optional, default is 3306
    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO sphinx_counters SELECT 'person', MAX(id), NOW() FROM persons
    sql_range_step  = 1000
    sql_query_range = SELECT (SELECT MIN(id) FROM persons), (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'person')
    sql_query       = \
		SELECT \
			id, \
			title, \
			first_name, \
			middle_name, \
			last_name, \
			name_for_label, \
			company_id, \
			(SELECT title FROM companies WHERE id = company_id) AS company_title, \
			department_id, \
			(SELECT title_short FROM companies WHERE id = company_id) AS company_title_short, \
			(SELECT title FROM departments WHERE id = department_id) AS department_title, \
			jobposition_id, \
			(SELECT title FROM jobpositions WHERE id = jobposition_id) AS jobposition_title, \
			CASE WHEN is_key_contact > 0 THEN 'keycontcat' ELSE '' END AS keycontact, \
			(SELECT title FROM countries WHERE id = country_id) AS country_title, \
			country_id, \
			(SELECT title FROM regions WHERE id = region_id) AS region_title, \
			region_id, \
			(SELECT title FROM cities WHERE id = city_id) AS city_title, \
			city_id, \
			zip, \
			address, \
			pobox, \
			languages, \
			notes, \
			birthday, \
			REPLACE((SELECT GROUP_CONCAT(title SEPARATOR ",") FROM contactdata WHERE object_alias = 'person' AND object_id = persons.id), ' ', '') AS contactdata, \
			UNIX_TIMESTAMP(modified_at) AS modified_at \
		FROM persons \
		WHERE id >= $start AND id <= $end AND id <= (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'person')
    sql_attr_uint   	= company_id
    sql_attr_timestamp  = modified_at
}

source mam_persons_delta : mam_persons {
    type = mysql
    sql_query_pre = SET NAMES utf8
    sql_range_step = 1000
    sql_query_range = SELECT (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'person'), (SELECT MAX(id) FROM persons)
    sql_query       = \
		SELECT \
			id, \
			title, \
			first_name, \
			middle_name, \
			last_name, \
			name_for_label, \
			company_id, \
			(SELECT title FROM companies WHERE id = company_id) AS company_title, \
			department_id, \
			(SELECT title_short FROM companies WHERE id = company_id) AS company_title_short, \
			(SELECT title FROM departments WHERE id = department_id) AS department_title, \
			jobposition_id, \
			(SELECT title FROM jobpositions WHERE id = jobposition_id) AS jobposition_title, \
			CASE WHEN is_key_contact > 0 THEN 'keycontcat' ELSE '' END AS keycontact, \
			(SELECT title FROM countries WHERE id = country_id) AS country_title, \
			country_id, \
			(SELECT title FROM regions WHERE id = region_id) AS region_title, \
			region_id, \
			(SELECT title FROM cities WHERE id = city_id) AS city_title, \
			city_id, \
			zip, \
			address, \
			pobox, \
			languages, \
			notes, \
			birthday, \
			REPLACE((SELECT GROUP_CONCAT(title SEPARATOR ",") FROM contactdata WHERE object_alias = 'person' AND object_id = persons.id), ' ', '') AS contactdata, \
			UNIX_TIMESTAMP(modified_at) AS modified_at \
		FROM persons \
		WHERE id >= $start AND id <= $end AND id <= (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'person') \
		OR modified_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'person')
    sql_query_killlist = SELECT id FROM persons WHERE modified_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'person')	
}

index ix_mam_persons_morphology
{
    source          = mam_persons
    path            = c:\sphinx\data\mam_persons_morphology
    morphology      = stem_ru, stem_en
    min_word_len    = 1
    charset_type    = utf-8
}

index ix_mam_persons_morphology_delta : ix_mam_persons_morphology
{
    source          = mam_persons_delta
    path            = c:\sphinx\data\mam_persons_morphology_delta
}

index ix_mam_persons
{
    source          = mam_persons
    path            = c:\sphinx\data\mam_persons
    min_word_len    = 1
	enable_star 	= 1
	min_infix_len 	= 1
    charset_type    = utf-8
}

index ix_mam_persons_delta : ix_mam_persons
{
    source          = mam_persons_delta
    path            = c:\sphinx\data\mam_persons_delta
}


#####################
#   mam.biz   		#
#####################
source mam_bizes
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = 
    sql_db          = mam
    sql_port        = 3306
    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO sphinx_counters SELECT 'biz', MAX(id), NOW() FROM bizes
    sql_range_step  = 1000
    sql_query_range = SELECT (SELECT MIN(id) FROM bizes), (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'biz')
    sql_query       = \
		SELECT \
			biz_companies.id, \
			bizes.id AS biz_id, \
			biz_companies.company_id AS company_id, \
			bizes.number, \
			bizes.suffix, \
			bizes.title AS biz_title, \
			CONCAT(IF(bizes.number > 999, '', IF(bizes.number > 99, '0', IF(bizes.number > 9, '00', '000'))), bizes.number, IF(bizes.suffix > 0, CONCAT('.', IF(bizes.suffix < 10, CONCAT('0', bizes.suffix), bizes.suffix)), '')) AS full_number, \
			bizes.description, \
			(SELECT title FROM objectives WHERE id = bizes.objective_id) AS objective, \
			(SELECT title FROM markets WHERE id = bizes.market_id) AS market, \
			(SELECT title FROM teams WHERE id = bizes.team_id) AS team, \
			(SELECT title FROM products WHERE id = bizes.product_id) AS product, \
			bizes.`status`, \
			(SELECT CONCAT(login, ',', nickname) FROM users WHERE id = bizes.driver_id) AS driver, \
			UNIX_TIMESTAMP(bizes.modified_at) AS modified_at, \
			companies.title AS company_title, \
			companies.title_short AS company_title_short, \
			companies.title_trade AS company_title_trade \
		FROM biz_companies \
		JOIN bizes ON bizes.id = biz_companies.biz_id \
		JOIN companies ON companies.id = biz_companies.company_id \
		WHERE bizes.id >= $start AND bizes.id <= $end AND bizes.id <= (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'biz')
    sql_attr_uint 		= biz_id
	sql_attr_uint 		= company_id
	sql_attr_uint 		= number
	sql_attr_uint 		= suffix
	sql_attr_timestamp  = modified_at
}

source mam_bizes_delta : mam_bizes {
    type 			= mysql
    sql_query_pre 	= SET NAMES utf8
    sql_range_step 	= 1000
    sql_query_range =
    sql_query       = \
		SELECT \
			biz_companies.id, \
			bizes.id AS biz_id, \
			biz_companies.company_id AS company_id, \
			bizes.number, \
			bizes.suffix, \
			bizes.title AS biz_title, \
			CONCAT(IF(bizes.number > 999, '', IF(bizes.number > 99, '0', IF(bizes.number > 9, '00', '000'))), bizes.number, IF(bizes.suffix > 0, CONCAT('.', IF(bizes.suffix < 10, CONCAT('0', bizes.suffix), bizes.suffix)), '')) AS full_number, \
			bizes.description, \
			(SELECT title FROM objectives WHERE id = bizes.objective_id) AS objective, \
			(SELECT title FROM markets WHERE id = bizes.market_id) AS market, \
			(SELECT title FROM teams WHERE id = bizes.team_id) AS team, \
			(SELECT title FROM products WHERE id = bizes.product_id) AS product, \
			bizes.`status`, \
			(SELECT CONCAT(login, ',', nickname) FROM users WHERE id = bizes.driver_id) AS driver, \
			UNIX_TIMESTAMP(bizes.modified_at) AS modified_at, \
			companies.title AS company_title, \
			companies.title_short AS company_title_short, \
			companies.title_trade AS company_title_trade \
		FROM biz_companies \
		JOIN bizes ON bizes.id = biz_companies.biz_id \
		JOIN companies ON companies.id = biz_companies.company_id \
		WHERE bizes.id > (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'biz') \
		OR bizes.modified_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'biz')
    sql_query_killlist = SELECT id FROM bizes WHERE modified_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'biz')	
}

index ix_mam_bizes
{
    source          = mam_bizes
    path            = c:\sphinx\data\mam_bizes
    enable_star 	= 1
	min_word_len    = 3	
	min_infix_len 	= 4
    charset_type    = utf-8
	ignore_chars 	= U+2E
}

index ix_mam_bizes_delta : ix_mam_bizes
{
    source          = mam_bizes_delta
    path            = c:\sphinx\data\mam_bizes_delta
}



#####################
#   mam.company   	#
#####################
source mam_companies
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = 
    sql_db          = mam
    sql_port        = 3306
    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO sphinx_counters SELECT 'company', MAX(id), NOW() FROM companies
    sql_range_step  = 1000
    sql_query_range = SELECT (SELECT MIN(id) FROM companies), (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'company')
    sql_query       = \
		SELECT \
			id, \
			id AS company_id, \
			title, \
			title_native,\
			title_short, \
			title_trade, \
			status_id, \
			relation_id, \
			country_id, \
			region_id, \
			city_id, \
			address, \
			address_native, \
			delivery_address, \
			data_labels, \
			notes, \
			bank_data, \
			reg_data, \
			(SELECT GROUP_CONCAT(product_id SEPARATOR ",") FROM company_products WHERE company_id = companies.id AND alias = 'p') AS product_id, \
			(SELECT GROUP_CONCAT(product_id SEPARATOR ",") FROM company_products WHERE company_id = companies.id AND alias = 'f') AS feedstock_id, \
			(SELECT GROUP_CONCAT(ancestors SEPARATOR ",") FROM company_activities WHERE company_id = companies.id) AS activity_id, \
			(SELECT GROUP_CONCAT(first_name, ' ', last_name, ' ', name_for_label SEPARATOR ",") FROM persons WHERE company_id = companies.id) AS persons, \
			REPLACE((SELECT GROUP_CONCAT(title SEPARATOR ",") FROM contactdata WHERE object_alias = 'company' AND object_id = companies.id), ' ', '') AS contactdata, \
			UNIX_TIMESTAMP(modified_at) AS modified_at \
		FROM companies \
		WHERE companies.id >= $start AND companies.id <= $end AND companies.id <= (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'company')
    sql_attr_uint 		= country_id
	sql_attr_uint 		= region_id
	sql_attr_uint 		= city_id
	sql_attr_uint 		= product_id
	sql_attr_uint 		= feedstock_id
	sql_attr_uint 		= activity_id
	sql_attr_uint 		= status_id
	sql_attr_uint 		= relation_id
	sql_attr_timestamp  = modified_at
}

source mam_companies_delta : mam_companies {
    type 			= mysql
    sql_query_pre 	= SET NAMES utf8
    sql_range_step 	= 1000
    sql_query_range =
    sql_query       = \
		SELECT \
			id, \
			id AS company_id, \
			title, \
			title_native,\
			title_short, \
			title_trade, \
			status_id, \
			relation_id, \
			country_id, \
			region_id, \
			city_id, \
			address, \
			address_native, \
			delivery_address, \
			data_labels, \
			notes, \
			bank_data, \
			reg_data, \
			(SELECT GROUP_CONCAT(product_id SEPARATOR ",") FROM company_products WHERE company_id = companies.id AND alias = 'p') AS product_id, \
			(SELECT GROUP_CONCAT(product_id SEPARATOR ",") FROM company_products WHERE company_id = companies.id AND alias = 'f') AS feedstock_id, \
			(SELECT GROUP_CONCAT(ancestors SEPARATOR ",") FROM company_activities WHERE company_id = companies.id) AS activity_id, \
			(SELECT GROUP_CONCAT(first_name, ' ', last_name, ' ', name_for_label SEPARATOR ",") FROM persons WHERE company_id = companies.id) AS persons, \
			REPLACE((SELECT GROUP_CONCAT(title SEPARATOR ",") FROM contactdata WHERE object_alias = 'company' AND object_id = companies.id), ' ', '') AS contactdata, \
			UNIX_TIMESTAMP(modified_at) AS modified_at \
		FROM companies \
		WHERE companies.id > (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'company') \
		OR companies.modified_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'company')
    sql_query_killlist = SELECT id FROM companies WHERE modified_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'company')	
}

index ix_mam_companies
{
    source          = mam_companies
    path            = c:\sphinx\data\mam_companies
    enable_star 	= 1
	min_word_len    = 2	
	min_infix_len 	= 3
    charset_type    = utf-8
}

index ix_mam_companies_delta : ix_mam_companies
{
    source          = mam_companies_delta
    path            = c:\sphinx\data\mam_companies_delta
}

source mam_companies_strict
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = 
    sql_db          = mam
    sql_port        = 3306
    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO sphinx_counters SELECT 'company', MAX(id), NOW() FROM companies
    sql_range_step  = 1000
    sql_query_range = SELECT (SELECT MIN(id) FROM companies), (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'company')
    sql_query       = \
		SELECT \
			id, \
			id AS company_id, \
			title, \
			title_native,\
			title_short, \
			title_trade, \
			status_id, \
			relation_id, \
			country_id, \
			region_id, \
			city_id, \
			address, \
			address_native, \
			delivery_address, \
			data_labels, \
			notes, \
			bank_data, \
			reg_data, \
			(SELECT GROUP_CONCAT(product_id SEPARATOR ",") FROM company_products WHERE company_id = companies.id AND alias = 'p') AS product_id, \
			(SELECT GROUP_CONCAT(product_id SEPARATOR ",") FROM company_products WHERE company_id = companies.id AND alias = 'f') AS feedstock_id, \
			(SELECT GROUP_CONCAT(ancestors SEPARATOR ",") FROM company_activities WHERE company_id = companies.id) AS activity_id, \
			(SELECT GROUP_CONCAT(first_name, ' ', last_name, ' ', name_for_label SEPARATOR ",") FROM persons WHERE company_id = companies.id) AS persons, \
			REPLACE((SELECT GROUP_CONCAT(title SEPARATOR ",") FROM contactdata WHERE object_alias = 'company' AND object_id = companies.id), ' ', '') AS contactdata, \
			UNIX_TIMESTAMP(modified_at) AS modified_at \
		FROM companies \
		WHERE companies.id >= $start AND companies.id <= $end AND companies.id <= (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'company')
    sql_attr_uint 		= country_id
	sql_attr_uint 		= region_id
	sql_attr_uint 		= city_id
	sql_attr_uint 		= product_id
	sql_attr_uint 		= feedstock_id
	sql_attr_uint 		= activity_id
	sql_attr_uint 		= status_id
	sql_attr_uint 		= relation_id
	sql_attr_timestamp  = modified_at
}

source mam_companies_strict_delta : mam_companies_strict {
    type 			= mysql
    sql_query_pre 	= SET NAMES utf8
    sql_range_step 	= 1000
    sql_query_range =
    sql_query       = \
		SELECT \
			id, \
			id AS company_id, \
			title, \
			title_native,\
			title_short, \
			title_trade, \
			status_id, \
			relation_id, \
			country_id, \
			region_id, \
			city_id, \
			address, \
			address_native, \
			delivery_address, \
			data_labels, \
			notes, \
			bank_data, \
			reg_data, \
			(SELECT GROUP_CONCAT(product_id SEPARATOR ",") FROM company_products WHERE company_id = companies.id AND alias = 'p') AS product_id, \
			(SELECT GROUP_CONCAT(product_id SEPARATOR ",") FROM company_products WHERE company_id = companies.id AND alias = 'f') AS feedstock_id, \
			(SELECT GROUP_CONCAT(ancestors SEPARATOR ",") FROM company_activities WHERE company_id = companies.id) AS activity_id, \
			(SELECT GROUP_CONCAT(first_name, ' ', last_name, ' ', name_for_label SEPARATOR ",") FROM persons WHERE company_id = companies.id) AS persons, \
			REPLACE((SELECT GROUP_CONCAT(title SEPARATOR ",") FROM contactdata WHERE object_alias = 'company' AND object_id = companies.id), ' ', '') AS contactdata, \
			UNIX_TIMESTAMP(modified_at) AS modified_at \
		FROM companies \
		WHERE companies.id > (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'company') \
		OR companies.modified_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'company')
    sql_query_killlist = SELECT id FROM companies WHERE modified_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'company')	
}

index ix_mam_companies_strict
{
    source          = mam_companies_strict
    path            = c:\sphinx\data\mam_companies_strict
	min_word_len    = 2	
    charset_type    = utf-8
}

index ix_mam_companies_strict_delta : ix_mam_companies_strict
{
    source          = mam_companies_strict_delta
    path            = c:\sphinx\data\mam_companies_strict_delta
}


#####################
#   mam.message   	#
#####################
source mam_messages
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = 
    sql_db          = mam
    sql_port        = 3306
    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO sphinx_counters SELECT 'message', MAX(id), NOW() FROM messages
    sql_range_step  = 1000
    sql_query_range = SELECT (SELECT MIN(id) FROM messages), (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'message')
    sql_query       = \
		SELECT \
			message_users.id AS id, \
			messages.id AS message_id, \
			messages.type_id, \
			messages.role_id, \
			messages.sender_id, \
			message_users.user_id AS recipient_id, \
			messages.title_source AS title, \
			messages.description_source AS description, \
			messages.deadline, \
			messages.is_alert, \
			messages.is_pending, \
			UNIX_TIMESTAMP(messages.created_at) as created_at, \
			UNIX_TIMESTAMP(messages.created_at) AS modified_at \
		FROM message_users \
		JOIN messages ON message_users.message_id = messages.id \
		WHERE messages.id >= $start AND messages.id <= $end AND messages.id <= (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'message')
    sql_attr_uint 		= message_id
	sql_attr_uint 		= type_id
	sql_attr_uint 		= role_id
	sql_attr_uint 		= sender_id
	sql_attr_uint 		= recipient_id
	sql_attr_uint 		= deadline
	sql_attr_uint 		= is_alert
	sql_attr_uint 		= is_pending	
	sql_attr_timestamp  = created_at
	sql_attr_timestamp  = modified_at
}

source mam_messages_delta : mam_messages {
    type 			= mysql
    sql_query_pre 	= SET NAMES utf8
    sql_range_step 	= 1000
    sql_query_range =
    sql_query       = \
		SELECT \
			message_users.id AS id, \
			messages.id AS message_id, \
			messages.type_id, \
			messages.role_id, \
			messages.sender_id, \
			message_users.user_id AS recipient_id, \
			messages.title_source AS title, \
			messages.description_source AS description, \
			messages.deadline, \
			messages.is_alert, \
			messages.is_pending, \
			UNIX_TIMESTAMP(messages.created_at) as created_at, \
			UNIX_TIMESTAMP(messages.created_at) AS modified_at \
		FROM message_users \
		JOIN messages ON message_users.message_id = messages.id \
		WHERE messages.id > (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'message') \
		OR messages.created_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'message')
    sql_query_killlist = SELECT id FROM messages WHERE created_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'message')	
}

index ix_mam_messages
{
    source          = mam_messages
    path            = c:\sphinx\data\mam_messages
    enable_star 	= 1
	min_word_len    = 2	
	min_infix_len 	= 3
    charset_type    = utf-8
}

index ix_mam_messages_delta : ix_mam_messages
{
    source          = mam_messages_delta
    path            = c:\sphinx\data\mam_messages_delta
}


#################################
#   mam.mam_contact_emails  	#
#################################
source mam_contact_emails
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = 
    sql_db          = mam
    sql_port        = 3306
    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO sphinx_counters SELECT 'email', MAX(id), NOW() FROM contactdata WHERE `type` = 'email'
    sql_range_step  = 1000
    sql_query_range = SELECT (SELECT MIN(id) FROM contactdata WHERE `type` = 'email'), (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'email')
    sql_query       = \
		SELECT \
			id, \
			id AS contactdata_id, \
			object_alias, \
			object_id, \
			CASE WHEN object_alias = 'company' THEN object_id ELSE 0 END AS company_id, \
			CASE WHEN object_alias = 'company' THEN IFNULL((SELECT TRIM(CONCAT(title, ' ', title_short, ' ', title_trade)) FROM companies WHERE id = object_id), '') ELSE '' END AS company_title, \
			CASE WHEN object_alias = 'person' THEN object_id ELSE 0 END AS person_id, \
			CASE WHEN object_alias = 'person' THEN IFNULL((SELECT TRIM(CONCAT(last_name, ' ', first_name)) FROM persons WHERE id = object_id), '') ELSE '' END AS person_title, \
			title AS email, \
			UNIX_TIMESTAMP(created_at) AS modified_at \
		FROM contactdata \
		WHERE type = 'email' AND id >= $start AND id <= $end AND id <= (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'email')
	sql_attr_uint 		= contactdata_id
	sql_attr_uint 		= company_id
	sql_attr_uint 		= person_id
	sql_attr_timestamp  = modified_at
}

source mam_contact_emails_delta : mam_contact_emails {
    type 			= mysql
    sql_query_pre 	= SET NAMES utf8
    sql_range_step 	= 1000
    sql_query_range =
    sql_query       = \
		SELECT \
			id, \
			id AS contactdata_id, \
			object_alias, \
			object_id, \
			CASE WHEN object_alias = 'company' THEN object_id ELSE 0 END AS company_id, \
			CASE WHEN object_alias = 'company' THEN IFNULL((SELECT TRIM(CONCAT(title, ' ', title_short, ' ', title_trade)) FROM companies WHERE id = object_id), '') ELSE '' END AS company_title, \
			CASE WHEN object_alias = 'person' THEN object_id ELSE 0 END AS person_id, \
			CASE WHEN object_alias = 'person' THEN IFNULL((SELECT TRIM(CONCAT(last_name, ' ', first_name)) FROM persons WHERE id = object_id), '') ELSE '' END AS person_title, \
			title AS email, \
			UNIX_TIMESTAMP(created_at) AS modified_at \
		FROM contactdata \
		WHERE type = 'email' AND id > (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'email') \
		OR created_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'email')
    sql_query_killlist = SELECT id FROM contactdata WHERE type = 'email' && created_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'email')
}

index ix_mam_contact_emails
{
    source          = mam_contact_emails
    path            = c:\sphinx\data\mam_contact_emails
    enable_star 	= 1
	min_word_len    = 2	
	min_infix_len 	= 3
    charset_type    = utf-8
	ignore_chars 	= U+2E
}

index ix_mam_contact_emails_delta : ix_mam_contact_emails
{
    source          = mam_contact_emails_delta
    path            = c:\sphinx\data\mam_contact_emails_delta
}



#####################
#   mam.emails   	#
#####################
source mam_emails
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = 
    sql_db          = mam
    sql_port        = 3306
    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO sphinx_counters SELECT 'email', MAX(id), NOW() FROM emails
    sql_range_step  = 1000
    sql_query_range = SELECT (SELECT MIN(id) FROM emails), (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'email')
    sql_query       = \
		SELECT \
			email_mailboxes.id AS id, \
			email_mailboxes.email_id, \
			email_mailboxes.mailbox_id, \
			emails.type_id, \
			emails.sender_address, \
			emails.recipient_address, \
			emails.cc_address, \
			emails.title, \
			emails.description, \
			(SELECT GROUP_CONCAT(original_name SEPARATOR ",") FROM attachments JOIN attachment_objects ON attachments.id = attachment_objects.attachment_id WHERE attachment_objects.object_alias = 'email' AND attachment_objects.object_id = emails.id) AS attachments, \
			UNIX_TIMESTAMP(emails.date_mail) AS date_mail, \
			UNIX_TIMESTAMP(emails.created_at) AS created_at, \
			UNIX_TIMESTAMP(emails.created_at) AS modified_at \
		FROM email_mailboxes \
		JOIN emails ON email_mailboxes.email_id = emails.id \
		WHERE emails.id >= $start AND emails.id <= $end AND emails.id <= (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'email')
    sql_attr_uint 		= email_id
	sql_attr_uint 		= type_id
	sql_attr_uint 		= mailbox_id
	sql_attr_timestamp  = created_at
	sql_attr_timestamp  = modified_at
	sql_attr_timestamp  = date_mail
}

source mam_emails_delta : mam_emails {
    type 			= mysql
    sql_query_pre 	= SET NAMES utf8
    sql_range_step 	= 1000
    sql_query_range =
    sql_query       = \
		SELECT \
			email_mailboxes.id AS id, \
			email_mailboxes.email_id, \
			email_mailboxes.mailbox_id, \
			emails.type_id, \
			emails.sender_address, \
			emails.recipient_address, \
			emails.cc_address, \
			emails.title, \
			emails.description, \
			(SELECT GROUP_CONCAT(original_name SEPARATOR ",") FROM attachments JOIN attachment_objects ON attachments.id = attachment_objects.attachment_id WHERE attachment_objects.object_alias = 'email' AND attachment_objects.object_id = emails.id) AS attachments, \
			UNIX_TIMESTAMP(emails.date_mail) AS date_mail, \
			UNIX_TIMESTAMP(emails.created_at) as created_at, \
			UNIX_TIMESTAMP(emails.created_at) AS modified_at \
		FROM email_mailboxes \
		JOIN emails ON email_mailboxes.email_id = emails.id \
		WHERE emails.id > (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'email') \
		OR emails.created_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'email')
    sql_query_killlist = SELECT id FROM emails WHERE created_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'email')	
}

index ix_mam_emails
{
    source          = mam_emails
    path            = c:\sphinx\data\mam_emails
    enable_star 	= 1
	min_word_len    = 1
	min_infix_len 	= 2
    charset_type    = utf-8
	ignore_chars 	= U+2E, U+AD, U+3A, U+3B
}

index ix_mam_emails_delta : ix_mam_emails
{
    source          = mam_emails_delta
    path            = c:\sphinx\data\mam_emails_delta
}



#########################
#   mam.object_emails	#
#########################
source mam_object_emails
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = 
    sql_db          = mam
    sql_port        = 3306
    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO sphinx_counters SELECT 'email', MAX(id), NOW() FROM emails
    sql_range_step  = 1000
    sql_query_range = SELECT (SELECT MIN(id) FROM emails), (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'email')
    sql_query       = \
		SELECT \
			email_objects.id AS id, \
			email_objects.email_id, \
			email_objects.object_alias, \
			CRC32(email_objects.object_alias) AS object_alias_id, \
			email_objects.object_id, \
			emails.type_id, \
			emails.sender_address, \
			emails.recipient_address, \
			emails.cc_address, \
			emails.title, \
			emails.description, \
			(SELECT GROUP_CONCAT(original_name SEPARATOR ",") FROM attachments JOIN attachment_objects ON attachments.id = attachment_objects.attachment_id WHERE attachment_objects.object_alias = 'email' AND attachment_objects.object_id = emails.id) AS attachments, \
			(SELECT SUM(POW(2, mailbox_id)) FROM email_mailboxes WHERE email_id = emails.id) AS mailboxes_bit, \
			UNIX_TIMESTAMP(emails.date_mail) AS date_mail, \
			UNIX_TIMESTAMP(emails.created_at) as created_at, \
			UNIX_TIMESTAMP(emails.created_at) AS modified_at \
		FROM email_objects \
		JOIN emails ON email_objects.email_id = emails.id \
		WHERE emails.id >= $start AND emails.id <= $end AND emails.id <= (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'email')
    sql_attr_uint 		= email_id
	sql_attr_uint 		= object_alias_id
	sql_attr_uint 		= object_id
	sql_attr_uint 		= type_id
	sql_attr_uint 		= mailboxes_bit
	sql_attr_timestamp  = created_at
	sql_attr_timestamp  = modified_at
	sql_attr_timestamp  = date_mail
}

source mam_object_emails_delta : mam_object_emails {
    type 			= mysql
    sql_query_pre 	= SET NAMES utf8
    sql_range_step 	= 1000
    sql_query_range =
    sql_query       = \
		SELECT \
			email_objects.id AS id, \
			email_objects.email_id, \
			email_objects.object_alias, \
			CRC32(email_objects.object_alias) AS object_alias_id, \
			email_objects.object_id, \
			emails.type_id, \
			emails.sender_address, \
			emails.recipient_address, \
			emails.cc_address, \
			emails.title, \
			emails.description, \
			(SELECT GROUP_CONCAT(original_name SEPARATOR ",") FROM attachments JOIN attachment_objects ON attachments.id = attachment_objects.attachment_id WHERE attachment_objects.object_alias = 'email' AND attachment_objects.object_id = emails.id) AS attachments, \
			(SELECT SUM(POW(2, mailbox_id)) FROM email_mailboxes WHERE email_id = emails.id) AS mailboxes_bit, \
			UNIX_TIMESTAMP(emails.date_mail) AS date_mail, \
			UNIX_TIMESTAMP(emails.created_at) as created_at, \
			UNIX_TIMESTAMP(emails.created_at) AS modified_at \
		FROM email_objects \
		JOIN emails ON email_objects.email_id = emails.id \
		WHERE emails.id > (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'email') \
		OR emails.created_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'email')
    sql_query_killlist = SELECT id FROM emails WHERE created_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'email')	
}

index ix_mam_object_emails
{
    source          = mam_object_emails
    path            = c:\sphinx\data\mam_object_emails
    enable_star 	= 1
	min_word_len    = 2	
	min_infix_len 	= 3
    charset_type    = utf-8
}

index ix_mam_object_emails_delta : ix_mam_object_emails
{
    source          = mam_object_emails_delta
    path            = c:\sphinx\data\mam_object_emails_delta
}


#########################
#   mam.blog_emails	    #
#########################
source mam_blog_emails
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = 
    sql_db          = mam
    sql_port        = 3306
    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO sphinx_counters SELECT 'blog_email', MAX(id), NOW() FROM emails
    sql_range_step  = 1000
    sql_query       = \
		SELECT 25 * 100000000 * em.id + 25 * eo.id + 1 AS id \
	        , 25 * em.email_id + 1 AS guid \
			, 1 AS entity_type \
	        , em.email_id AS entity_id \
	        , e.title AS title \
	        , e.description AS description \
	        , CRC32(eo.object_alias) AS object_alias \
	        , eo.object_id AS object_id \
	        , em.mailbox_id AS mailbox_id \
	        , UNIX_TIMESTAMP(e.date_mail) AS created_at \
	        , e.created_by AS created_by \
	        , 6 AS role_id \
	        , 0 AS message_sender_id \
	        , 0 AS message_recipient_id \
			, 0 AS message_type_id \
        FROM email_mailboxes AS em \
        INNER JOIN email_objects AS eo ON eo.email_id = em.email_id \
        INNER JOIN emails AS e ON e.id = em.email_id
    sql_attr_uint       = entity_type
    sql_attr_uint       = entity_id
    sql_attr_uint       = object_alias
    sql_attr_uint       = object_id
    sql_attr_uint       = mailbox_id
    sql_attr_timestamp  = created_at
    sql_attr_uint       = created_by
    sql_attr_uint       = role_id
	sql_attr_uint       = message_type_id
    sql_attr_uint       = message_sender_id
    sql_attr_uint       = message_recipient_id
	sql_attr_uint       = guid

}

index ix_mam_blog_emails
{
    source          = mam_blog_emails
    path            = c:\sphinx\data\mam_blog_emails
    enable_star 	= 1
	min_word_len    = 2	
	min_infix_len 	= 3
    charset_type    = utf-8
}

source mam_blog_emails_delta : mam_blog_emails {
    type 			= mysql
    sql_query_pre 	= SET NAMES utf8
    sql_range_step 	= 1000
    sql_query       = \
		SELECT 25 * 100000000 * em.id + 25 * eo.id + 1 AS id \
	        , 25 * em.email_id + 1 AS guid \
			, 1 AS entity_type \
	        , em.email_id AS entity_id \
	        , e.title AS title \
	        , e.description AS description \
	        , CRC32(eo.object_alias) AS object_alias \
	        , eo.object_id AS object_id \
	        , em.mailbox_id AS mailbox_id \
	        , UNIX_TIMESTAMP(e.date_mail) AS created_at \
	        , e.created_by AS created_by \
	        , 6 AS role_id \
	        , 0 AS message_sender_id \
	        , 0 AS message_recipient_id \
			, 0 AS message_type_id \
        FROM email_mailboxes AS em \
        INNER JOIN email_objects AS eo ON eo.email_id = em.email_id \
        INNER JOIN emails AS e ON e.id = em.email_id \
		WHERE e.id > (SELECT sc.max_doc_id FROM sphinx_counters AS sc WHERE sc.object_alias = 'blog_email') \
		OR e.modified_at >= (SELECT sc.last_reindex_at FROM sphinx_counters AS sc WHERE sc.object_alias = 'blog_email')
    sql_query_killlist = \
        SELECT 25 * 100000000 * em.id + 25 * eo.id + 1 AS id \
        FROM email_mailboxes AS em \
        INNER JOIN email_objects AS eo ON eo.email_id = em.email_id \
        INNER JOIN emails AS e ON e.id = em.email_id \
        WHERE e.deleted_at >= (SELECT sc.last_reindex_at FROM sphinx_counters AS sc WHERE sc.object_alias = 'blog_email')	
}

index ix_mam_blog_emails_delta : ix_mam_blog_emails
{
    source          = mam_blog_emails_delta
    path            = c:\sphinx\data\mam_blog_emails_delta
}

#########################
#   mam.blog_messages	#
#########################
source mam_blog_messages
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = 
    sql_db          = mam
    sql_port        = 3306
    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO sphinx_counters SELECT 'blog_message', MAX(id), NOW() FROM messages
    sql_range_step  = 1000
    sql_query       = \
		SELECT 25 * 100000000 * mu.id + 25 * mo.id + 2 AS id \
	        , 25 * mu.message_id + 2 AS guid \
			, 2 AS entity_type \
	        , mu.message_id AS entity_id \
	        , m.title AS title \
	        , m.description AS description \
	        , CRC32(mo.object_alias) AS object_alias \
	        , mo.object_id AS object_id \
	        , 0 AS mailbox_id \
	        , UNIX_TIMESTAMP(m.created_at) AS created_at \
	        , m.created_by AS created_by \
	        , mu.role_id AS role_id \
	        , mu.sender_id AS message_sender_id \
	        , 0 AS message_recipient_id \
			, mu.type_id AS message_type_id \
        FROM message_users AS mu \
        INNER JOIN message_objects AS mo ON mo.message_id = mu.message_id \
        INNER JOIN messages AS m ON m.id = mu.message_id \
        WHERE mu.type_id IN (0,1,8,9)
    sql_attr_uint       = entity_type
    sql_attr_uint       = entity_id
    sql_attr_uint       = object_alias
    sql_attr_uint       = object_id
    sql_attr_uint       = mailbox_id
    sql_attr_timestamp  = created_at
    sql_attr_uint       = created_by
    sql_attr_uint       = role_id
	sql_attr_uint       = message_type_id	
    sql_attr_uint       = message_sender_id
    sql_attr_uint       = message_recipient_id
	sql_attr_uint       = guid
}

index ix_mam_blog_messages
{
    source          = mam_blog_messages
    path            = c:\sphinx\data\mam_blog_messages
    enable_star 	= 1
	min_word_len    = 2	
	min_infix_len 	= 3
    charset_type    = utf-8
}

source mam_blog_messages_delta : mam_blog_messages {
    type 			= mysql
    sql_query_pre 	= SET NAMES utf8
    sql_range_step 	= 1000
    sql_query       = \
		SELECT 25 * 100000000 * mu.id + 25 * mo.id + 2 AS id \
	        , 25 * mu.message_id + 2 AS guid \
			, 2 AS entity_type \
	        , mu.message_id AS entity_id \
	        , m.title AS title \
	        , m.description AS description \
	        , CRC32(mo.object_alias) AS object_alias \
	        , mo.object_id AS object_id \
	        , 0 AS mailbox_id \
	        , UNIX_TIMESTAMP(m.created_at) AS created_at \
	        , m.created_by AS created_by \
	        , mu.role_id AS role_id \
	        , mu.sender_id AS message_sender_id \
	        , 0 AS message_recipient_id \
			, mu.type_id AS message_type_id \
        FROM message_users AS mu \
        INNER JOIN message_objects AS mo ON mo.message_id = mu.message_id \
        INNER JOIN messages AS m ON m.id = mu.message_id \
        WHERE mu.type_id IN (0,1,8,9) \
        AND m.id > (SELECT sc.max_doc_id FROM sphinx_counters AS sc WHERE sc.object_alias = 'blog_message')
}

index ix_mam_blog_messages_delta : ix_mam_blog_messages
{
    source          = mam_blog_messages_delta
    path            = c:\sphinx\data\mam_blog_messages_delta
}

############################
#   mam.blog_attachments   #
############################
source mam_blog_attachments
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = 
    sql_db          = mam
    sql_port        = 3306
    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO sphinx_counters SELECT 'blog_attachment', MAX(id), NOW() FROM attachments
    sql_range_step  = 1000
    sql_query       = \
		SELECT 25 * id + 3 AS id \
	        , 25 * id + 3 AS guid \
			, 3 AS entity_type \
	        , id AS entity_id \
	        , original_name AS title \
	        , '' AS description \
	        , CRC32(object_alias) AS object_alias \
	        , object_id AS object_id \
	        , 0 AS mailbox_id \
	        , UNIX_TIMESTAMP(created_at) AS created_at \
	        , created_by AS created_by \
	        , 6 AS role_id \
	        , 0 AS message_sender_id \
	        , 0 AS message_recipient_id \
			, 0 AS message_type_id \
        FROM attachments \
        WHERE object_alias NOT IN ('emailraw', 'emailhtml')
    sql_attr_uint       = entity_type
    sql_attr_uint       = entity_id
    sql_attr_uint       = object_alias
    sql_attr_uint       = object_id
    sql_attr_uint       = mailbox_id
    sql_attr_timestamp  = created_at
    sql_attr_uint       = created_by
    sql_attr_uint       = role_id
	sql_attr_uint       = message_type_id	
    sql_attr_uint       = message_sender_id
    sql_attr_uint       = message_recipient_id
	sql_attr_uint       = guid
}

index ix_mam_blog_attachments
{
    source          = mam_blog_attachments
    path            = c:\sphinx\data\mam_blog_attachments
    enable_star 	= 1
	min_word_len    = 2	
	min_infix_len 	= 3
    charset_type    = utf-8
}

source mam_blog_attachments_delta : mam_blog_attachments {
    type 			= mysql
    sql_query_pre 	= SET NAMES utf8
    sql_range_step 	= 1000
    sql_query       = \
		SELECT 25 * id + 3 AS id \
	        , 25 * id + 3 AS guid \
			, 3 AS entity_type \
	        , id AS entity_id \
	        , original_name AS title \
	        , '' AS description \
	        , CRC32(object_alias) AS object_alias \
	        , object_id AS object_id \
	        , 0 AS mailbox_id \
	        , UNIX_TIMESTAMP(created_at) AS created_at \
	        , created_by AS created_by \
	        , 6 AS role_id \
	        , 0 AS message_sender_id \
	        , 0 AS message_recipient_id \
			, 0 AS message_type_id \
        FROM attachments \
        WHERE object_alias NOT IN ('emailraw', 'emailhtml') \
        AND id > (SELECT sc.max_doc_id FROM sphinx_counters AS sc WHERE sc.object_alias = 'blog_attachment')
    sql_query_killlist = \
        SELECT 25 * id + 3 AS id \
        FROM attachments \
        WHERE object_alias NOT IN ('emailraw', 'emailhtml') \
        AND modified_at >= (SELECT sc.last_reindex_at FROM sphinx_counters AS sc WHERE sc.object_alias = 'blog_attachment')	
}

index ix_mam_blog_attachments_delta : ix_mam_blog_attachments
{
    source          = mam_blog_attachments_delta
    path            = c:\sphinx\data\mam_blog_attachments_delta
}


#######

searchd
{
    listen          = 9312
    #listen          = 9306:mysql41
    log             = c:\sphinx\log\searchd.log
    query_log       = c:\sphinx\log\query.log
    pid_file        = c:\sphinx\log\searchd.pid
    max_matches     = 10000
}
