#####################
#   mam.emails   	#
#####################
source mam_emails
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = rdflhjcjan
    sql_db          = mam
    sql_port        = 3306
    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO sphinx_counters SELECT 'email', MAX(id), NOW() FROM emails
    sql_range_step  = 1000
    sql_query_range = SELECT (SELECT MIN(id) FROM emails), (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'email')
    sql_query       = \
		SELECT \
			email_mailboxes.id AS id, \
			email_mailboxes.email_id, \
			email_mailboxes.mailbox_id, \
			emails.type_id, \
			emails.sender_address, \
			emails.recipient_address, \
			emails.cc_address, \
			emails.bcc_address, \
			emails.title, \
			emails.description, \
			(SELECT GROUP_CONCAT(original_name SEPARATOR ",") FROM attachments JOIN attachment_objects ON attachments.id = attachment_objects.attachment_id WHERE attachment_objects.object_alias = 'email' AND attachment_objects.object_id = emails.id) AS attachments, \
			UNIX_TIMESTAMP(emails.date_mail) AS date_mail, \
			UNIX_TIMESTAMP(emails.created_at) AS created_at, \
			UNIX_TIMESTAMP(emails.created_at) AS modified_at \
		FROM email_mailboxes \
		JOIN emails ON email_mailboxes.email_id = emails.id \
		WHERE emails.id >= $start AND emails.id <= $end AND emails.id <= (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'email')
    sql_attr_uint 		= email_id
	sql_attr_uint 		= type_id
	sql_attr_uint 		= mailbox_id
	sql_attr_timestamp  = created_at
	sql_attr_timestamp  = modified_at
	sql_attr_timestamp  = date_mail
}

source mam_emails_delta : mam_emails {
    type 			= mysql
    sql_query_pre 	= SET NAMES utf8
    sql_range_step 	= 1000
    sql_query_range =
    sql_query       = \
		SELECT \
			email_mailboxes.id AS id, \
			email_mailboxes.email_id, \
			email_mailboxes.mailbox_id, \
			emails.type_id, \
			emails.sender_address, \
			emails.recipient_address, \
			emails.cc_address, \
			emails.bcc_address, \
			emails.title, \
			emails.description, \
			(SELECT GROUP_CONCAT(original_name SEPARATOR ",") FROM attachments JOIN attachment_objects ON attachments.id = attachment_objects.attachment_id WHERE attachment_objects.object_alias = 'email' AND attachment_objects.object_id = emails.id) AS attachments, \
			UNIX_TIMESTAMP(emails.date_mail) AS date_mail, \
			UNIX_TIMESTAMP(emails.created_at) as created_at, \
			UNIX_TIMESTAMP(emails.created_at) AS modified_at \
		FROM email_mailboxes \
		JOIN emails ON email_mailboxes.email_id = emails.id \
		WHERE emails.id > (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'email') \
		OR emails.created_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'email')
    sql_query_killlist = SELECT id FROM emails WHERE created_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'email')	
}

index ix_mam_emails
{
    source          = mam_emails
    path            = /etc/sphinxsearch/data/mam_emails
    enable_star 	= 1
	min_word_len    = 1
	min_infix_len 	= 2
    charset_type    = utf-8
	ignore_chars 	= U+2E, U+AD, U+3A, U+3B
}

index ix_mam_emails_delta : ix_mam_emails
{
    source          = mam_emails_delta
    path            = /etc/sphinxsearch/data/mam_emails_delta
}

#########################
#   mam.object_emails	#
#########################
source mam_object_emails
{
    type            = mysql
    sql_host        = localhost
    sql_user        = root
    sql_pass        = rdflhjcjan
    sql_db          = mam
    sql_port        = 3306
    sql_query_pre   = SET NAMES utf8
    sql_query_pre   = REPLACE INTO sphinx_counters SELECT 'email', MAX(id), NOW() FROM emails
    sql_range_step  = 1000
    sql_query_range = SELECT (SELECT MIN(id) FROM emails), (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'email')
    sql_query       = \
		SELECT \
			email_objects.id AS id, \
			email_objects.email_id, \
			email_objects.object_alias, \
			CRC32(email_objects.object_alias) AS object_alias_id, \
			email_objects.object_id, \
			emails.type_id, \
			emails.sender_address, \
			emails.recipient_address, \
			emails.cc_address, \
			emails.bcc_address, \
			emails.title, \
			emails.description, \
			(SELECT GROUP_CONCAT(original_name SEPARATOR ",") FROM attachments JOIN attachment_objects ON attachments.id = attachment_objects.attachment_id WHERE attachment_objects.object_alias = 'email' AND attachment_objects.object_id = emails.id) AS attachments, \
			(SELECT SUM(POW(2, mailbox_id)) FROM email_mailboxes WHERE email_id = emails.id) AS mailboxes_bit, \
			UNIX_TIMESTAMP(emails.date_mail) AS date_mail, \
			UNIX_TIMESTAMP(emails.created_at) as created_at, \
			UNIX_TIMESTAMP(emails.created_at) AS modified_at \
		FROM email_objects \
		JOIN emails ON email_objects.email_id = emails.id \
		WHERE emails.id >= $start AND emails.id <= $end AND emails.id <= (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'email')
    sql_attr_uint 		= email_id
	sql_attr_uint 		= object_alias_id
	sql_attr_uint 		= object_id
	sql_attr_uint 		= type_id
	sql_attr_uint 		= mailboxes_bit
	sql_attr_timestamp  = created_at
	sql_attr_timestamp  = modified_at
	sql_attr_timestamp  = date_mail
}

source mam_object_emails_delta : mam_object_emails {
    type 			= mysql
    sql_query_pre 	= SET NAMES utf8
    sql_range_step 	= 1000
    sql_query_range =
    sql_query       = \
		SELECT \
			email_objects.id AS id, \
			email_objects.email_id, \
			email_objects.object_alias, \
			CRC32(email_objects.object_alias) AS object_alias_id, \
			email_objects.object_id, \
			emails.type_id, \
			emails.sender_address, \
			emails.recipient_address, \
			emails.cc_address, \
			emails.bcc_address, \
			emails.title, \
			emails.description, \
			(SELECT GROUP_CONCAT(original_name SEPARATOR ",") FROM attachments JOIN attachment_objects ON attachments.id = attachment_objects.attachment_id WHERE attachment_objects.object_alias = 'email' AND attachment_objects.object_id = emails.id) AS attachments, \
			(SELECT SUM(POW(2, mailbox_id)) FROM email_mailboxes WHERE email_id = emails.id) AS mailboxes_bit, \
			UNIX_TIMESTAMP(emails.date_mail) AS date_mail, \
			UNIX_TIMESTAMP(emails.created_at) as created_at, \
			UNIX_TIMESTAMP(emails.created_at) AS modified_at \
		FROM email_objects \
		JOIN emails ON email_objects.email_id = emails.id \
		WHERE emails.id > (SELECT max_doc_id FROM sphinx_counters WHERE object_alias = 'email') \
		OR emails.created_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'email')
    sql_query_killlist = SELECT id FROM emails WHERE created_at >= (SELECT last_reindex_at FROM sphinx_counters WHERE object_alias = 'email')	
}

index ix_mam_object_emails
{
    source          = mam_object_emails
    path            = /etc/sphinxsearch/data/mam_object_emails
    enable_star 	= 1
	min_word_len    = 2	
	min_infix_len 	= 3
    charset_type    = utf-8
}

index ix_mam_object_emails_delta : ix_mam_object_emails
{
    source          = mam_object_emails_delta
    path            = /etc/sphinxsearch/data/mam_object_emails_delta
}


