<?php
require_once APP_PATH . 'classes/common/mimetype.class.php';
require_once APP_PATH . 'classes/models/attachment.class.php';
require_once APP_PATH . 'classes/models/biz.class.php';
require_once APP_PATH . 'classes/models/cmr.class.php';
require_once APP_PATH . 'classes/models/company.class.php';
require_once APP_PATH . 'classes/models/ddt.class.php';
require_once APP_PATH . 'classes/models/inddt.class.php';
require_once APP_PATH . 'classes/models/invoice.class.php';
require_once APP_PATH . 'classes/models/oc.class.php';
require_once APP_PATH . 'classes/models/order.class.php';
require_once APP_PATH . 'classes/models/person.class.php';
require_once APP_PATH . 'classes/models/qc.class.php';
require_once APP_PATH . 'classes/models/ra.class.php';
require_once APP_PATH . 'classes/models/sc.class.php';
require_once APP_PATH . 'classes/models/supplierinvoice.class.php';
require_once APP_PATH . 'classes/models/picture.class.php';

class MainAjaxController extends ApplicationAjaxController
{    
    /**
     * Допустимые форматы файлов
     * 
     * @var mixed
     */
    var $allowed_extensions = array(
        'bmp'   => 'picture',
        'jpg'   => 'picture',
        'jpe'   => 'picture',
        'jpeg'  => 'picture',
        'gif'   => 'picture',
        'png'   => 'picture',
        'tiff'  => 'picture',
        'tif'   => 'picture',
        'pic'   => 'picture',
        'pcx'   => 'picture',
        'tga'   => 'picture',
        
        'dwg'   => 'other',
        'psd'   => 'other',
        'dfx'   => 'other',
        'pdf'   => 'other',
        '3ds'   => 'other',
        'xlsx'  => 'other',
        'xls'   => 'other',
        'docx'  => 'other',
        'doc'   => 'other',
        'fla'   => 'other',
        'flx'   => 'other',
        'fly'   => 'other',
        '3gp'   => 'other',
        'zip'   => 'other',
        'rar'   => 'other',
        '7z'    => 'other',
        'gzip'  => 'other',
        'tar'   => 'other',
        'txt'   => 'other',
        'xml'   => 'other',
        'ppt'   => 'other',
        'mp3'   => 'other'
    );
    
    function MainAjaxController()
    {
        ApplicationAjaxController::ApplicationAjaxController();
        
        $this->authorize_before_exec['upload']      = ROLE_STAFF;
        $this->authorize_before_exec['setasmain']   = ROLE_STAFF;
        $this->authorize_before_exec['remove']      = ROLE_STAFF;
        $this->authorize_before_exec['getimages']   = ROLE_STAFF;        
    }
    
    /**
     * Возвращает набор картиок для объекта
     * url:/attachment/getimages
     */
    function getimages()
    {
        $object_alias   = Request::GetString('object_alias', $_REQUEST);
        $object_id      = Request::GetInteger('object_id', $_REQUEST);
        $album_alias    = Request::GetString('album_alias', $_REQUEST);

        if (in_array($album_alias, array('stockoffer_header', 'stockoffer_footer', 'stockoffer_banner1', 'stockoffer_banner2')))
        {
            
        }
        
        $content = 'Image set';
        
        $this->_send_json(array('result' => 'okay', 'content' => $content));
    }
    
    /**
     * Удаляет атачмент
     * url: /attachment/remove
     * 
     * @version 20120805, zharkov: добавлено удаление из об\екта и физическое удалени только из создававшего объекта
     * @version 20130227, d10n: добалена возможность удаления временно-загруженных файлов
     */
    function remove()
    {
        $object_alias   = Request::GetString('object_alias', $_REQUEST);
        $object_id      = Request::GetInteger('object_id', $_REQUEST);
        $attachment_id  = Request::GetInteger('attachment_id', $_REQUEST);
        
        if (empty($attachment_id)) $this->_send_json(array('result' => 'error', 'message' => 'Attachment Id must be specified !'));
        
        // проверка на существование временных файлов
        // и последующее удаление
        $key_in_session = 'attachments-' . $object_alias . '-' . $object_id;
        if (array_key_exists($key_in_session, $_SESSION) && array_key_exists($attachment_id, $_SESSION[$key_in_session]))
        {
            unset($_SESSION[$key_in_session][$attachment_id]);
            $this->_send_json(array('result' => 'okay'));
        }
        
        $attachments    = new Attachment();
        $attachment     = $attachments->GetById($attachment_id);
        
        if (empty($attachment)) $this->_send_json(array('result' => 'error', 'message' => 'Attachment is not exist !'));
        
        
        // физически удаляется только из того объекта в котором атачмент создан
        if ($object_alias == $attachment['object_alias'] && $object_id == $attachment['object_id'])
        {
            $attachments->Remove($attachment_id);
            
            // если удаляется главное изображение объекта, то выбирается другое главное изображение
            if ($attachment['type'] == 'image' && $attachment['is_main'] > 0) 
            {
                $this->update_object_picture($attachment['object_alias'], $attachment['object_id'], $attachment_id);
            }            
        }
        
        // удаляет атачмент из объекта
        $attachments->RemoveFromObject($attachment_id, $object_alias, $object_id);
        
        // удаляет атачмент изсессии (для случая когда они были загружены)
        if (isset($_SESSION['attachments-' . $object_alias . '-' . $object_id]))
        {
            unset($_SESSION['attachments-' . $object_alias . '-' . $object_id][$attachment_id]);
        }
        
        
        $this->_send_json(array('result' => 'okay'));        
    }
    
    /**
     * Устанавливает главную картинку для объекта
     * url: /attachment/setasmain
     */
    function setasmain()
    {
        $attachment_id  = Request::GetInteger('attachment_id', $_REQUEST);
        if (empty($attachment_id)) $this->_send_json(array('result' => 'error', 'message' => 'Attachment Id must be specified !'));
        
        $attachments    = new Attachment();
        $attachment     = $attachments->GetById($attachment_id);
        if (empty($attachment)) $this->_send_json(array('result' => 'error', 'message' => 'Attachment is not exist !'));
        
        if ($attachment['type'] != 'image') $this->_send_json(array('result' => 'error', 'message' => 'Attachment has wrong type !'));
        
        $pictures   = new Picture();
        $result     = $pictures->SetAsMain($attachment_id);        
        if (empty($result)) $this->_send_json(array('result' => 'error', 'message' => 'Error updating main picture !'));
        
        $this->update_object_picture($result['object_alias'], $result['object_id'], $attachment_id);
        
        $this->_send_json(array('result' => 'okay'));
    }
    
    /**
     * Добавляет файл через FileUploader
     * url: /attachment/upload
     */
    function upload()
    {
        $file_name      = Request::GetHtmlString('qqfile', $_REQUEST);
        $object_alias   = Request::GetString('object_alias', $_REQUEST);
        $object_id      = Request::GetInteger('object_id', $_REQUEST);
        $outputstyle    = Request::GetString('outputstyle', $_REQUEST, 'simple');
        
        // 20120803, zharkov: email trick
        if ($object_alias == 'newemail') $object_id = $this->user_id;
        
        if (!empty($_FILES['qqfile']))
        $file_name = $_FILES['qqfile'];

        if (!empty($file_name))
        {
            // Проверка на максимальное число загружаемых файлов, не должно быть больше 50
            if (isset($_SESSION['attachments-' . $object_alias . '-' . $object_id]) && count($_SESSION['attachments-' . $object_alias . '-' . $object_id]) >= 150)
            {
                $this->_send_json(array('error' => 'Attachment limit reached .'));
                return;
            }
            
            if (empty($_FILES['qqfile']))
            {
                $input      = fopen("php://input", "r");
                $temp       = tmpfile();
                $real_size  = stream_copy_to_stream($input, $temp);
                fclose($input);

                if (isset($_SERVER["CONTENT_LENGTH"])) $size = (int) $_SERVER["CONTENT_LENGTH"];

                if ($real_size != $size)
                {  
                    $this->_send_json(array('error' => 'Error uploading file (wrong file type) .'));
                    return false;
                }

                $file_info      = pathinfo($file_name);
                $file_extension = $this->check_allowed_extension($file_info['extension']);

                if (empty($file_extension)) $this->_send_json(array('error' => 'Error uploading file (wrong file type) .'));

                $file_object['name']     = $file_name;
                $file_object['type']     = MimeType::GetMimeTypeByExtension(strtolower($file_info['extension']));
                $file_object['size']     = $real_size;
                $file_object['tmp_name'] = array('pFile' => $temp);
            }
            else
            {
                $file           = pathinfo($_FILES['qqfile']['name']);
                $file_extension = $this->check_allowed_extension($file['extension']);

                if (empty($file_extension)) $this->_send_json(array('error' => 'Error uploading file (wrong file type) .'));

                $file_object = $_FILES['qqfile'];
            }
            
            $attachments    = $file_extension == 'picture' ? new Picture() : new Attachment();
            $attachment_id  = $attachments->Save(0, $object_alias, $object_id, $file_object);
            $attachment     = $attachments->GetById($attachment_id);
            
            // обновляет главную картинку объекта
            if ($attachment['type'] == 'image' && $attachment['is_main'] > 0) $this->update_object_picture($object_alias, $object_id, $attachment_id);
            
            if (!empty($temp)) fclose($temp);
            
            //Добавляет ID загруженного файла в сессию, для дальнейшего сохранения
            $_SESSION['attachments-' . $object_alias . '-' . $object_id][$attachment['id']] = true;
            
            if (!empty($_FILES['qqfile']))
            $this->_assign('is_frame', true);

            $this->_assign('attachment', $attachment);
            switch ($outputstyle)
            {
                case 'text':
                    $content = $this->smarty->fetch('templates/html/dropbox/control_attachment_block_text.tpl');
                    break;
                
                case 'table-row':
                    $this->_assign('can_be_edited', 1);
                    $content['table_row'] = $this->smarty->fetch('templates/controls/share_files_row.tpl');
                    
                    $this->_assign('object_alias',  $object_alias);
                    $this->_assign('object_id',     $object_id);
                    $content['span'] = $this->smarty->fetch('templates/controls/object_shared_file_span.tpl');
                    break;
                
                default:
                    $content = $this->smarty->fetch('templates/html/dropbox/control_attachment_block.tpl');
            }

            if (empty($_FILES['qqfile']))
            {
                $this->_send_json(array('success' => true, 'content' => $content));
            }
            else 
            {
                // выдача контента в frame
                echo $content; 
            }
        }
    }
    
    /**
     * Проверяет доступно ли данное расширение для загрузки 
     * 
     * @param string $ext
     */
    private function check_allowed_extension($ext)
    {
        $ext = strtolower($ext);
        return isset($this->allowed_extensions[$ext]) ? $this->allowed_extensions[$ext] : null;
    }
    
    /**
     * Обновляет главную картинку объекта
     * 
     * @param mixed $object_alias
     * @param mixed $object_id
     * @param mixed $attachment_id
     */
    private function update_object_picture($object_alias, $object_id, $attachment_id)
    {
        if ($object_alias == 'person')
        {
            $persons = new Person();
            $persons->UpdatePicture($object_id, $attachment_id);
        }        
    }
    
    /**
     * Возвращает список файлов для конкретного объекта<br />
     * HTML-код подготовленный для модального окна
     * @url /attachment/getmodalbox
     * @version 20130222, d10n
     */
    public function getmodalbox()
    {
        $object_alias   = Request::GetString('oalias', $_REQUEST);
        $object_id      = Request::GetInteger('oid', $_REQUEST);
        
        if (!in_array($object_alias, array('biz', 'cmr', 'company', 'ddt', 'inddt', 'invoice', 'oc', 'order', 'person', 'qc', 'ra', 'sc', 'supplierinvoice', )))
        {
            $this->_send_json(array('result' => 'error', 'message' => 'Object not found',));
        }
        
        if ($object_id <= 0)
        {
            $this->_send_json(array('result' => 'error', 'message' => 'Object not found',));
        }
//TODO d10n 20130220: Провести рефактор switch-case
        switch($object_alias)
        {
            case 'biz' :
                $instance = new BIZ();
                $object = $instance->GetById($object_id);
                $object = array_key_exists($object_alias, $object) ? $object[$object_alias] : array();
                break;
            
            case 'cmr' :
                $instance = new CMR();
                $object = $instance->GetById($object_id);
                $object = array_key_exists($object_alias, $object) ? $object[$object_alias] : array();
                break;
            
            case 'company' :
                $instance = new Company();
                $object = $instance->GetById($object_id);
                $object = array_key_exists($object_alias, $object) ? $object[$object_alias] : array();
                break;
            
            case 'ddt' :
                $instance = new DDT();
                $object = $instance->GetById($object_id);
                $object = array_key_exists($object_alias, $object) ? $object[$object_alias] : array();
                break;
            
            case 'inddt' :
                $instance = new InDDT();
                $object = $instance->GetById($object_id);
                $object = array_key_exists($object_alias, $object) ? $object[$object_alias] : array();
                break;
            
            case 'invoice' :
                $instance = new Invoice();
                $object = $instance->GetById($object_id);
                $object = array_key_exists($object_alias, $object) ? $object[$object_alias] : array();
                break;
            
            case 'oc' :
                $instance = new OC();
                $object = $instance->GetById($object_id);
                $object = array_key_exists($object_alias, $object) ? $object[$object_alias] : array();
                break;
            
            case 'order' :
                $instance = new Order();
                $object = $instance->GetById($object_id);
                $object = array_key_exists($object_alias, $object) ? $object[$object_alias] : array();
                break;
            
            case 'person' :
                $instance = new Person();
                $object = $instance->GetById($object_id);
                $object = array_key_exists($object_alias, $object) ? $object[$object_alias] : array();
                break;
            
            case 'qc' :
                $instance = new QC();
                $object = $instance->GetById($object_id);
                $object = array_key_exists($object_alias, $object) ? $object[$object_alias] : array();
                break;
            
            case 'ra' :
                $instance = new RA();
                $object = $instance->GetById($object_id);
                $object = array_key_exists($object_alias, $object) ? $object[$object_alias] : array();
                break;
            
            case 'sc' :
                $instance = new SC();
                $object = $instance->GetById($object_id);
                $object = array_key_exists($object_alias, $object) ? $object[$object_alias] : array();
                break;
            
            case 'supplierinvoice' :
                $instance = new SupplierInvoice();
                $object = $instance->GetById($object_id);
                $object = array_key_exists('supinvoice', $object) ? $object['supinvoice'] : array();
                break;
            
            default :
                $object = array();
        }
        
        if (empty($object))
        {
            $this->_send_json(array('result' => 'error', 'message' => 'Object not found'));
        }
// @deprecated 20130227, d10n: список всегда будет пустым
//        $modelAttachment = new Attachment();
//        $list = $modelAttachment->GetListByType('', $object_alias, $object_id);
//        $this->_assign('list',          $list['data']);
//        
        // проверка на существование временных файлов
        $key_in_session = 'attachments-' . $object_alias . '-' . $object_id;
        if (array_key_exists($key_in_session, $_SESSION))
        {
            unset($_SESSION[$key_in_session]);
        }
        
        $this->_assign('object_alias',  $object_alias);
        $this->_assign('object_id',     $object_id);
/*        
        $modalbox_content = $this->smarty->fetch('templates/controls/modalbox_shared_files.tpl');
        $this->_assign('modalbox_content', $modalbox_content);
        
        $data = $this->smarty->fetch('templates/controls/modalbox.tpl');
*/        
        $this->_send_json(array(
            'result'    => 'okay', 
            'content'   => $this->smarty->fetch('templates/controls/share_files.tpl')
        ));
    }
    
    /**
     * Сохраняет аттачмент(ы) в системе
     * @url /attachment/save
     * @verions 20130227, d10n
     */
    public function save()
    {
        $object_alias   = Request::GetString('oalias', $_REQUEST);
        $object_id      = Request::GetInteger('oid', $_REQUEST);
        
        $titles_list    = isset($_REQUEST['titles']) ? $_REQUEST['titles'] : array();
        $attachments    = array();
        
        // проверка на существование временных файлов
        // и последующая обработка
        $key_in_session = 'attachments-' . $object_alias . '-' . $object_id;
        if (array_key_exists($key_in_session, $_SESSION))
        {
            $attachments = $_SESSION[$key_in_session];
            //unset($_SESSION[$key_in_session]);
        }
        
        if (empty($attachments))
        {
            $this->_send_json(array('result' => 'error', 'message' => 'Files  not found !'));
        }
        
        $modelAttachment    = new Attachment();
        $modelPicture       = new Picture();
        
        $this->_assign('object_alias',  $object_alias);
        $this->_assign('object_id',     $object_id);
        
        $content = array('span' => '');
        $att_ids = array(); 
        foreach ($titles_list as $id => $title)
        {
            if (!array_key_exists($id, $attachments)) continue;
            
            $attachment = $attachments[$id];
            
            $file_extension = $this->check_allowed_extension($attachment['ext']);
            if (empty($file_extension)) continue;
            
            $attachmentObject   = $file_extension == 'picture' ? $modelPicture : $modelAttachment;
            $attachment_id      = $attachmentObject->Save(0, $object_alias, $object_id, $attachment['file_object'], $title);
            $attachment_saved   = $attachmentObject->GetById($attachment_id);
            
            if (!array_key_exists('id', $attachment_saved)) continue;
            
            $this->_assign('attachment', $attachment_saved);
            $content['span'] .= $this->smarty->fetch('templates/controls/object_shared_file_span.tpl');
            
            $att_ids[] = $attachment_saved['id'];
        }
        
        $this->_send_json(array('result' => 'okay', 'content' => $content, 'att_ids' => $att_ids));
    }
    
    /**
     * Файловый upload во временную папку приложения<br />
     * Примечание: временная папка ...../attachments/tmp/sharedfiles
     * 
     * @url /attachment/tempupload
     * 
     * @version 20130217, d10n
     */
    public function tempupload()
    {
        $file_name      = Request::GetHtmlString('qqfile', $_REQUEST);
        $object_alias   = Request::GetString('object_alias', $_REQUEST);
        $object_id      = Request::GetInteger('object_id', $_REQUEST);
        $outputstyle    = Request::GetString('outputstyle', $_REQUEST, 'simple');
        
        // проверяется, каким методом передаетс файл :
        // - если существует $_FILES, то метод POST, иначе XHR
        $is_XHR         = !array_key_exists('qqfile', $_FILES);
        
        if (!$is_XHR) $file_name = $_FILES['qqfile']['name'];
        
        if (empty($file_name))
        {
            $message = 'File Not Found !';
            
            if ($is_XHR) $this->_send_json(array('error' => $message));
            
            echo $message;
            exit;
        }
        
        if ($is_XHR)
        {
            // получение контента файла из потока
            $input          = fopen("php://input", "r");
            $tmp_resource_id= tmpfile();
            $real_size      = stream_copy_to_stream($input, $tmp_resource_id);
            fclose($input);
            
            // получение размера контента (файла)
            if (isset($_SERVER["CONTENT_LENGTH"])) $size = (int) $_SERVER["CONTENT_LENGTH"];
            
            // проверка корректности файлового размера
            if ($real_size != $size) $this->_send_json(array('error' => 'Error uploading file (wrong file type) .'));
            
            // получение информации о файле
            $file_pathinfo  = pathinfo($file_name);
            
            // проверка возможности закгрузки с данным расширением
            $file_extension = $this->check_allowed_extension($file_pathinfo['extension']);
            if (empty($file_extension)) $this->_send_json(array('error' => 'Error uploading file (wrong file type) .'));
            
            // транслитерация именни файла перед сохранением
            $file_name = Translit::EncodeAndClear($file_name);
            
            // формирование объекта аля $_FILES
            $file_object['name']     = $file_name;
            $file_object['type']     = MimeType::GetMimeTypeByExtension(strtolower($file_pathinfo['extension']));
            $file_object['size']     = $real_size;
            $file_object['tmp_name'] = array('pFile' => $tmp_resource_id);
            
            // перемещение файла во временную директорию проекта
            $tmpfile_path       = $this->_create_temporary_dir() . $file_name;
            $tmpfile_source_id  = fopen($tmpfile_path, "w");
            fseek($tmp_resource_id, 0, SEEK_SET);
            stream_copy_to_stream($tmp_resource_id, $tmpfile_source_id);
        }
        else
        {
            // получение информации о файле
            $file_pathinfo  = pathinfo($file_name);
            
            // проверка возможности закгрузки с данным расширением
            $file_extension = $this->check_allowed_extension($file_pathinfo['extension']);
            
            if (empty($file_extension))
            {
                echo 'Error uploading file (wrong file type) !.';
                exit;
            }
            
            // формирование объекта аля $_FILES
            $file_object = $_FILES['qqfile'];
            
            // транслитерация имени файла перед сохранением
            $file_name = Translit::EncodeAndClear($file_name);
            
            // перемещение файла во временную директорию проекта
            $tmpfile_path       = $this->_create_temporary_dir() . $file_name;
            move_uploaded_file($file_object['tmp_name'], $tmpfile_path);
        }
        
        $file_object['tmp_name']    = $tmpfile_path;
        $file_object['name']        = $file_name;
        $file_object['from_disc']   = true;
        
        $attachment = array(
            'id'            => time() - rand(10000, 20000) - 1300000000,
            'object_alias'  => $object_alias,
            'object_id'     => $object_id,
            'type'          => stristr($file_object['type'], 'image') ? 'image' : 'file',
            'ext'           => $file_pathinfo['extension'],
            'size'          => $file_object['size'],
            'original_name' => $file_name,
            'file_object'   => $file_object,
        );
        
        // формирование набора урлов временных файлов, для дальнейшей обработки
        $key_in_session = 'attachments-' . $object_alias . '-' . $object_id;
        
        if (!array_key_exists($key_in_session, $_SESSION))
        {
            $_SESSION[$key_in_session] = array();
        }
        
        $_SESSION[$key_in_session][$attachment['id']] = $attachment;
        
        // формирование контента
        $this->_assign('attachment', $attachment);
        switch ($outputstyle)
        {
            case 'table-row':
                $this->_assign('can_be_edited', 1);
                $content['table_row'] = $this->smarty->fetch('templates/controls/share_files_row.tpl');
                break;
                
            default:
                $content = $this->smarty->fetch('templates/html/dropbox/control_attachment_block.tpl');
        }
        
        if ($is_XHR)
        {
            $this->_send_json(array('success' => true, 'content' => $content));
        }
        else 
        {
            echo $content; 
        }
    }
    
    
    /**
     * Создает временную директорию для хранения временных файлов
     * @return string|boolean Путь к директории. В случае неудачи FALSE
     */
    private function _create_temporary_dir()
    {
        $temp_dir = ATTACHMENT_PATH . 'tmp/sharedfiles/' . md5(time()) . '/';
        
        if (is_dir($temp_dir)) return $temp_dir;
        
        $oldmask    = umask(0);
        $res        = mkdir($temp_dir, 0777, true);
        umask($oldmask);
        
        if (!$res) return FALSE;
        
        return  $temp_dir;
    }
}